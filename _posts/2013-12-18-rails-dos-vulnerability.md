---
layout: post
title: Ruby String Format Bug and Rails DoS Vulnerability
---

A few months ago, I discovered a vulnerability in Ruby on Rails that could be
used to crash the Rails process that sends your email (usually an asynchronous job
runner such as SideKiq or Beanstalk). I wanted to wait a bit before posting
about it, but there are now fixes in place in both Ruby and Rails, and I thought
others might find these bugs interesting so decided to write up a post
about it.

I originally noticed the bug in Ruby last summer when I was doing Rails development
at [Causes](https://www.causes.com).
I was playing around with a Rails number helper that allows you to specify precision,
like `number_to_currency(5, precision: 2)`. I attempted passing it a large precision,
such as 99999, and I was promptly met with this error message.

{% highlight bash %}
/home/aaron/.rbenv/versions/2.0.0-p247/lib/ruby/gems/2.0.0/gems/activesupport-4.0.0/lib/active_support/number_helper.rb:369: [BUG] Segmentation fault
{% endhighlight %}

I traced the error into Rails source code and came across this line in action_view:

{% highlight ruby %}
formatted_number = number_with_delimiter("%01.#{precision}f" % rounded_number, options)
{% endhighlight %}

This led me to realize the segmentation faults are caused when Ruby uses `printf`
with too high of a precision specified. It also shows that when we use both kinds
of Ruby\'s string interpolation, it first evaluates the entire string replacing the
`#{}` blocks with their output, and then it does the string format. If an application
accepts users input, this can be abused. For example, see the following code, where
`gets` just takes some input from the user.

{% highlight ruby %}
x = gets.chomp
puts "#{x} world %f" % 10
{% endhighlight %}

Under normal circumstances, the user would enter something like \"Hello\", and the
application would print out \"Hello world 10\". However, the user can enter \"%.999999f\"
and we\'ll see the same segfault we saw above. I decided to [ack](http://beyondgrep.com/)
through my rbenv gems folder, and in action\_mailer, the default mailer used for Rails, I found
a more interesting case. This method is from `ActionMailer::LogSubscriber` and
is called every time the mailer sends an email.


{% highlight ruby %}
def deliver(event)
  recipients = Array.wrap(event.payload[:to]).join(', ')
  info("\nSent mail to #{recipients} (%1.fms)" % event.duration)
  debug(event.payload[:mail])
end
{% endhighlight %}

Because many sites will send you emails at least once after you give them your
address, you can manipulate the text in the `recipients` variable. I have tested this,
and was able to create a fairly standard rails application that took a users
email and sent them an email. By entering an email like \"aaronneyer+%01.9999999f@gmail.com\", I
was able to cause the Rails server to crash, or if it was running in an asynchronous
worker, it would cause the worker to crash. This is especially fun if the asynchronous
worker has auto-retry and is also set up to reboot on crash. The worker will send
the email, try to log it, and crash, but not a Ruby exception like the worker
would catch. In that case, it would then reboot and keep looping, sending a new email each time.

This bug affected all Ruby versions, and all Rails 3.x versions. It has been fixed
on Rails [3.2.15](http://weblog.rubyonrails.org/2013/10/16/Rails-3-2-15-has-been-released/),
but Rails 3.0.x and 3.1.x are not still supported. For information on
the security fix, and for a patch that can be applied to other versions, see the
[ruby-security announcement](https://groups.google.com/forum/#!topic/ruby-security-ann/yvlR1Vx44c8).
A fix has also been made for Ruby and you can see the issue on
[Ruby\'s tracker](https://bugs.ruby-lang.org/issues/8864).
